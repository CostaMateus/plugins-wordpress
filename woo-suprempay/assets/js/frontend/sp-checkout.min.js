/**
 * @author Mateus Costa <mateus@costamateus.com.br>
 * @since 1.0.0
 */

!function(e){"use strict";e(function(){let a=!1;function r(a){e("#suprempay-cc-form").attr("data-cc-brand",a)}function d(e){let a=function e(a){let r="R$ "+parseFloat(a.installmentAmount,10).toFixed(2).replace(".",",").toString(),d="R$ "+parseFloat(a.totalAmount,10).toFixed(2).replace(".",",").toString(),o=!0===a.interestFree?wc_spg_params.interest_free:"",s=o||`(${d})`;return`${a.quantity}x ${r} ${s}`}(e),r=e.quantity,d=e.installmentAmount;return`<option value="${r}" data-installment-value="${d}">${a}</option>`}function o(a){let r=e("#suprempay-cc-form");e(".woocommerce-error",r).remove(),r.prepend(`<div class="woocommerce-error" style="margin-bottom: 0.5em !important;">${a}</div>`)}function s(a){e(".suprempay-method-form").hide(),e("#suprempay-payment-methods li").removeClass("active"),e(`#suprempay-${a}-form`).show(),e(`#suprempay-payment-method-${a}`).parent("label").parent("li").addClass("active")}function n(){let a;a=e("#suprempay-payment-methods"),1===e("input[type=radio]",a).length&&a.hide(),e("#suprempay-payment-form").show(),s(e("#suprempay-payment-methods input[type=radio]:checked").val()),e("#suprempay-card-holder-cpf-field").mask("000.000.000-00"),e("#suprempay-card-holder-cnpj-field").mask("00.000.000/0000-00"),e("#suprempay-card-holder-cnpj").hide(),e("#suprempay-card-holder-birth-date-field").mask("00/00/0000");let r=function(e){return 11===e.replace(/\D/g,"").length?"(00) 00000-0000":"(00) 0000-00009"};e("#suprempay-card-holder-phone-field").mask(r,{onKeyPress:function(e,a,d,o){d.mask(r.apply({},arguments),o)}})}function t(){if(a)return a=!1,!0;if(!e("#payment_method_suprempay").is(":checked")||!e("#suprempay-payment-method-cc").is(":checked"))return!0;let r=e("form.checkout, form#order_review"),d=!1,s="",n=e("#suprempay-card-holder-cpf-field",r).val(),t=e("#suprempay-card-holder-cnpj-field",r).val(),i=e("#suprempay-card-holder-phone-field",r).val(),l=e("#suprempay-card-holder-name-field",r).val(),p=e("#suprempay-card-number-field",r).val().replace(/[^\d]/g,""),c=e("#suprempay-card-cvc-field",r).val(),u=e("#suprempay-card-expiry-field",r).val().replace(/[^\d]/g,"").substr(0,2),m=e("#suprempay-card-expiry-field",r).val().replace(/[^\d]/g,"").substr(2),$=e("#suprempay-card-installment-field",r).val(),h=e("#suprempay-cc-form",r).attr("data-cc-brand"),f=new Date;return s+="<ul>",0==l.length&&(s+=`<li>${wc_spg_params.messages.invalid_holder}</li>`,d=!0),void 0===h||"error"===h?(s+=`<li>${wc_spg_params.messages.invalid_card}</li>`,d=!0):"unsupported"===h&&(s+=`<li>${wc_spg_params.messages.unsupported_card}</li>`,d=!0),(2!==u.length||4!==m.length)&&(s+=`<li>${wc_spg_params.messages.invalid_expiry}</li>`,d=!0),2===u.length&&4===m.length&&(u>12||m<=f.getFullYear()-1||m>=f.getFullYear()+20||u<f.getMonth()+2&&m.toString()===f.getFullYear().toString())&&(s+=`<li>${wc_spg_params.messages.expired_date}</li>`,d=!0),0==c.length&&(s+=`<li>${wc_spg_params.messages.invalid_cvv}</li>`,d=!0),"0"===$&&(s+=`<li>${wc_spg_params.messages.empty_installment}</li>`,d=!0),0==n.length&&0==t.length&&(s+=`<li>${wc_spg_params.messages.invalid_h_cpf}</li>`,d=!0),0==i.length&&(s+=`<li>${wc_spg_params.messages.invalid_h_phone}</li>`,d=!0),s+="</ul>",d?o(s):(r.append(e("<input name='suprempay_card_number'      type='hidden' />").val(p)),r.append(e("<input name='suprempay_card_cvc'         type='hidden' />").val(c)),r.append(e("<input name='suprempay_card_exp_month'   type='hidden' />").val(u)),r.append(e("<input name='suprempay_card_exp_year'    type='hidden' />").val(m.substring(2))),r.append(e("<input name='suprempay_card_brand'       type='hidden' />").val(h)),r.append(e("<input name='suprempay_card_installment' type='hidden' />").val($)),a=!0,r.submit()),!1}"1"===wc_checkout_params.is_checkout?e("body").on("updated_checkout",function(){n()}):n(),e("body").on("click","#suprempay-legal-person-field",function(){var a;(a=e(this).is(":checked"))?(e("#suprempay-card-holder-cpf").hide(),e("#suprempay-card-holder-cnpj").show()):(e("#suprempay-card-holder-cpf").show(),e("#suprempay-card-holder-cnpj").hide())}),e("body").on("click","#suprempay-payment-methods input[type=radio]",function(){s(e(this).val())}),e("body").on("focusout","#suprempay-card-number-field",function(){let a=e(this).val();a.length>=16&&a.length<=20&&e.ajax({url:`${wc_spg_params.base_url}/cards/brand`,type:"POST",data:{bin:a},success:function(a){let d=JSON.parse(a);d.error?(e("body").trigger("suprempay_credit_card_brand","error"),r("error")):d.brandInfo.supported?(e("body").trigger("suprempay_credit_card_brand",d.brandInfo.brand),r(d.brandInfo.brand)):(e("body").trigger("suprempay_credit_card_brand","unsupported"),r("unsupported"))},error:function(a){e("body").trigger("suprempay_credit_card_brand","error"),r("error")}})}),e("body").on("updated_checkout",function(){let a=e("body #suprempay-card-number-field");a.length>0&&a.focusout()}),e("body").on("focus","#suprempay-card-number-field, #suprempay-card-expiry-field",function(){e("#suprempay-cc-form .woocommerce-error").remove()}),e("body").on("suprempay_credit_card_brand",function(e,a){"unsupported"===a?o(wc_spg_params.messages.unsupported_card):"error"===a&&o(wc_spg_params.messages.invalid_card)}),e("form.checkout").on("checkout_place_order_suprempay",function(){return t()}),e("form#order_review").submit(function(){return t()})})}(jQuery);