/**
 * @author Mateus Costa <mateus@costamateus.com.br>
 * @since 1.0.0
 */

!function(e){"use strict";e(function(){let a=!1;function r(a){e("#pagare-cc-form").attr("data-cc-brand",a)}function n(e){let a=function e(a){let r="R$ "+parseFloat(a.installmentAmount,10).toFixed(2).replace(".",",").toString(),n="R$ "+parseFloat(a.totalAmount,10).toFixed(2).replace(".",",").toString(),t=!0===a.interestFree?wc_rpg_params.interest_free:"",d=t||`(${n})`;return`${a.quantity}x ${r} ${d}`}(e),r=e.quantity,n=e.installmentAmount;return`<option value="${r}" data-installment-value="${n}">${a}</option>`}function t(a){let r=e("#pagare-cc-form");e(".woocommerce-error",r).remove(),r.prepend(`<div class="woocommerce-error" style="margin-bottom: 0.5em !important;">${a}</div>`)}function d(a){e(".pagare-method-form").hide(),e("#pagare-payment-methods li").removeClass("active"),e(`#pagare-${a}-form`).show(),e(`#pagare-payment-method-${a}`).parent("label").parent("li").addClass("active")}function i(){let a;a=e("#pagare-payment-methods"),1===e("input[type=radio]",a).length&&a.hide(),e("#pagare-payment-form").show(),d(e("#pagare-payment-methods input[type=radio]:checked").val()),e("#pagare-card-holder-cpf-field").mask("000.000.000-00"),e("#pagare-card-holder-cnpj-field").mask("00.000.000/0000-00"),e("#pagare-card-holder-cnpj").hide(),e("#pagare-card-holder-birth-date-field").mask("00/00/0000");let r=function(e){return 11===e.replace(/\D/g,"").length?"(00) 00000-0000":"(00) 0000-00009"};e("#pagare-card-holder-phone-field").mask(r,{onKeyPress:function(e,a,n,t){n.mask(r.apply({},arguments),t)}})}function o(){if(a)return a=!1,!0;if(!e("#payment_method_pagare").is(":checked")||!e("#pagare-payment-method-cc").is(":checked"))return!0;let r=e("form.checkout, form#order_review"),n=!1,d="",i=e("#pagare-card-holder-cpf-field",r).val(),o=e("#pagare-card-holder-cnpj-field",r).val(),l=e("#pagare-card-holder-phone-field",r).val(),p=e("#pagare-card-holder-name-field",r).val(),c=e("#pagare-card-number-field",r).val().replace(/[^\d]/g,""),g=e("#pagare-card-cvc-field",r).val(),s=e("#pagare-card-expiry-field",r).val().replace(/[^\d]/g,"").substr(0,2),u=e("#pagare-card-expiry-field",r).val().replace(/[^\d]/g,"").substr(2),$=e("#pagare-card-installment-field",r).val(),m=e("#pagare-cc-form",r).attr("data-cc-brand"),h=new Date;return d+="<ul>",0==p.length&&(d+=`<li>${wc_rpg_params.messages.invalid_holder}</li>`,n=!0),void 0===m||"error"===m?(d+=`<li>${wc_rpg_params.messages.invalid_card}</li>`,n=!0):"unsupported"===m&&(d+=`<li>${wc_rpg_params.messages.unsupported_brand}</li>`,n=!0),(2!==s.length||2!==u.length&&4!==u.length)&&(d+=`<li>${wc_rpg_params.messages.invalid_expiry}</li>`,n=!0),2===s.length&&2===u.length&&(u+=2e3,(s>12||u<=h.getFullYear()-1||u>=h.getFullYear()+20||s<h.getMonth()+2&&u.toString()===h.getFullYear().toString())&&(d+=`<li>${wc_rpg_params.messages.expired_date}</li>`,n=!0)),0==g.length&&(d+=`<li>${wc_rpg_params.messages.invalid_cvv}</li>`,n=!0),"0"===$&&(d+=`<li>${wc_rpg_params.messages.empty_installment}</li>`,n=!0),0==i.length&&0==o.length&&(d+=`<li>${wc_rpg_params.messages.invalid_h_cpf}</li>`,n=!0),0==l.length&&(d+=`<li>${wc_rpg_params.messages.invalid_h_phone}</li>`,n=!0),d+="</ul>",n?t(d):(r.append(e("<input name='pagare_card_number'      type='hidden' />").val(c)),r.append(e("<input name='pagare_card_cvc'         type='hidden' />").val(g)),r.append(e("<input name='pagare_card_exp_month'   type='hidden' />").val(s)),r.append(e("<input name='pagare_card_exp_year'    type='hidden' />").val(u.substring(2))),r.append(e("<input name='pagare_card_brand'       type='hidden' />").val(m)),r.append(e("<input name='pagare_card_installment' type='hidden' />").val($)),a=!0,r.submit()),!1}"1"===wc_checkout_params.is_checkout?e("body").on("updated_checkout",function(){i()}):i(),e("body").on("click","#pagare-legal-person-field",function(){var a;(a=e(this).is(":checked"))?(e("#pagare-card-holder-cpf").hide(),e("#pagare-card-holder-cnpj").show()):(e("#pagare-card-holder-cpf").show(),e("#pagare-card-holder-cnpj").hide())}),e("body").on("click","#pagare-payment-methods input[type=radio]",function(){d(e(this).val())}),e("body").on("focusout","#pagare-card-number-field",function(){let a=e(this).val();a.length>=16&&a.length<=20&&e.ajax({url:`${wc_rpg_params.base_url}/cards/brand`,type:"POST",data:{bin:a},success:function(a){let n=JSON.parse(a);n.error?(e("body").trigger("pagare_credit_card_brand","error"),r("error")):n.brandInfo.supported?(e("body").trigger("pagare_credit_card_brand",n.brandInfo.brand),r(n.brandInfo.brand)):(e("body").trigger("pagare_credit_card_brand","unsupported"),r("unsupported"))},error:function(a){e("body").trigger("pagare_credit_card_brand","error"),r("error")}})}),e("body").on("updated_checkout",function(){let a=e("body #pagare-card-number-field");a.length>0&&a.focusout()}),e("body").on("focus","#pagare-card-number-field, #pagare-card-expiry-field",function(){e("#pagare-cc-form .woocommerce-error").remove()}),e("body").on("pagare_credit_card_brand",function(e,a){"unsupported"===a?t(wc_rpg_params.messages.unsupported_brand):"error"===a&&t(wc_rpg_params.messages.invalid_card)}),e("form.checkout").on("checkout_place_order_pagare",function(){return o()}),e("form#order_review").submit(function(){return o()})})}(jQuery);